<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å¯è§†åŒ–æ¨¡æ¿</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #4a5568;
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #4a5568;
            font-weight: 700;
        }

        header p {
            font-size: 1.1em;
            color: #666;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .controls button {
            background: #2d3748;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px 10px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(45, 55, 72, 0.3);
        }

        .controls button:hover {
            background: #1a202c;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(45, 55, 72, 0.4);
        }

        .controls button:active {
            transform: translateY(0);
        }

        .controls button.active {
            background: #e53e3e;
        }

        .info-panel {
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-area {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #4a5568;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .error-message {
            text-align: center;
            padding: 40px;
            background: #ffebee;
            border-radius: 10px;
            color: #c62828;
            margin: 20px 0;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            background: #e3f2fd;
            border-radius: 10px;
            color: #1976d2;
            margin: 20px 0;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .controls button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }

            header h1 {
                font-size: 2em;
            }

            .chart-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š æ•°æ®å¯è§†åŒ–å¹³å°</h1>
            <p>åŸºäºå®æ—¶æ•°æ®çš„äº¤äº’å¼å›¾è¡¨å±•ç¤º</p>
        </header>

        <main>
            <section class="controls">
                <button id="showTableBtn">ğŸ“‹ æ•°æ®è¡¨æ ¼</button>
                <button id="showBarChartBtn">ğŸ“Š æŸ±çŠ¶å›¾</button>
                <button id="showPieChartBtn">ğŸ¥§ é¥¼å›¾</button>
                <button id="showLineChartBtn">ğŸ“ˆ æŠ˜çº¿å›¾</button>
                <button id="refreshDataBtn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </section>

            <section class="info-panel">
                <div id="dataInfo" class="loading-message">
                    æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...
                </div>
            </section>

            <section class="chart-area">
                <div id="chartContainer" class="chart-container">
                    <div class="loading-message">
                        æ­£åœ¨åˆå§‹åŒ–å›¾è¡¨ç³»ç»Ÿ...
                    </div>
                </div>
                <div id="tableContainer" class="table-container" style="display: none;">
                    <div class="loading-message">
                        æ­£åœ¨å‡†å¤‡æ•°æ®è¡¨æ ¼...
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ç®€åŒ–çš„å›¾è¡¨ç»˜åˆ¶è„šæœ¬ -->
    <script>
        /**
         * ç®€åŒ–çš„å›¾è¡¨ç»˜åˆ¶è„šæœ¬
         * ä¸“é—¨ç”¨äºä» window.appData è¯»å–æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨
         */

        // å…¨å±€å˜é‡
        let currentData = null;
        let currentView = 'bar'; // å½“å‰æ˜¾ç¤ºçš„è§†å›¾ç±»å‹

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener("DOMContentLoaded", function() {
            console.log("æ•°æ®å¯è§†åŒ–æ¨¡æ¿åŠ è½½å®Œæˆ");

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            const buttons = [
                { id: 'showTableBtn', handler: showTable, view: 'table' },
                { id: 'showBarChartBtn', handler: drawBarChart, view: 'bar' },
                { id: 'showPieChartBtn', handler: drawPieChart, view: 'pie' },
                { id: 'showLineChartBtn', handler: drawLineChart, view: 'line' },
                { id: 'refreshDataBtn', handler: refreshData, view: 'bar' }
            ];

            buttons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    element.addEventListener('click', () => {
                        setActiveButton(btn.id);
                        btn.handler();
                        currentView = btn.view;
                    });
                }
            });

            // å»¶è¿ŸåŠ è½½æ•°æ®
            setTimeout(loadDataAndDraw, 200);
        });

        /**
         * è®¾ç½®æ´»åŠ¨æŒ‰é’®çŠ¶æ€
         */
        function setActiveButton(activeId) {
            document.querySelectorAll('.controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId)?.classList.add('active');
        }

        /**
         * åŠ è½½æ•°æ®å¹¶ç»˜åˆ¶é»˜è®¤å›¾è¡¨
         */
        function loadDataAndDraw() {
            try {
                console.log("å¼€å§‹åŠ è½½æ•°æ®...");

                if (!window.appData) {
                    console.log("ç­‰å¾…æ•°æ®åŠ è½½...");
                    setTimeout(loadDataAndDraw, 100);
                    return;
                }

                console.log("æ•°æ®å·²åŠ è½½:", window.appData);
                currentData = processData(window.appData);
                console.log("å¤„ç†åçš„æ•°æ®:", currentData);

                if (currentData.length === 0) {
                    showError("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼");
                    return;
                }

                updateInfoPanel();
                drawBarChart(); // é»˜è®¤æ˜¾ç¤ºæŸ±çŠ¶å›¾
                setActiveButton('showBarChartBtn');

            } catch (error) {
                console.error("æ•°æ®åŠ è½½å¤±è´¥:", error);
                showError("æ•°æ®åŠ è½½å¤±è´¥: " + error.message);
            }
        }

        /**
         * å¤„ç†æ•°æ®
         */
        function processData(data) {
            if (!data) return [];

            // å¤„ç†è¯­è¨€æµè¡Œåº¦æ•°æ®
            if (data.languagePopularity && Array.isArray(data.languagePopularity)) {
                return data.languagePopularity.map(item => ({
                    name: item.language || item.ç¼–ç¨‹è¯­è¨€ || 'Unknown',
                    value: parseFloat(item.percentage || item.æµè¡Œåº¦ç™¾åˆ†æ¯” || 0),
                    users: parseFloat(item.users || item.å¼€å‘è€…æ•°é‡ || 0),
                    growth: parseFloat(item.growth || item.å¢é•¿ç‡ || 0),
                    salary: parseFloat(item.salary || item.å¹³å‡è–ªèµ„ || 0)
                }));
            }

            // å¤„ç†æ•°ç»„æ ¼å¼æ•°æ®
            if (Array.isArray(data)) {
                return data.map((item, index) => ({
                    name: item.language || item.ç¼–ç¨‹è¯­è¨€ || item.name || `é¡¹ç›®${index + 1}`,
                    value: parseFloat(item.percentage || item.æµè¡Œåº¦ç™¾åˆ†æ¯” || item.value || item.æ•°å€¼ || 0),
                    users: parseFloat(item.users || item.å¼€å‘è€…æ•°é‡ || 0),
                    growth: parseFloat(item.growth || item.å¢é•¿ç‡ || 0),
                    salary: parseFloat(item.salary || item.å¹³å‡è–ªèµ„ || 0)
                }));
            }

            return [];
        }

        /**
         * æ›´æ–°ä¿¡æ¯é¢æ¿
         */
        function updateInfoPanel() {
            const infoPanel = document.getElementById("dataInfo");
            if (!infoPanel || !currentData || currentData.length === 0) return;

            const totalItems = currentData.length;
            const totalValue = currentData.reduce((sum, item) => sum + item.value, 0);
            const avgGrowth = currentData.reduce((sum, item) => sum + item.growth, 0) / totalItems;
            const maxSalary = Math.max(...currentData.map(item => item.salary));

            infoPanel.className = 'fade-in';
            infoPanel.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; padding: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${totalItems}</div>
                        <div style="color: #666;">æ•°æ®é¡¹</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${totalValue.toFixed(1)}%</div>
                        <div style="color: #666;">æ€»å€¼</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${avgGrowth.toFixed(1)}%</div>
                        <div style="color: #666;">å¹³å‡å¢é•¿</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">$${(maxSalary/1000).toFixed(0)}K</div>
                        <div style="color: #666;">æœ€é«˜è–ªèµ„</div>
                    </div>
                </div>
            `;
        }

        /**
         * æ˜¾ç¤ºè¡¨æ ¼
         */
        function showTable() {
            hideAllCharts();
            const tableContainer = document.getElementById("tableContainer");
            const chartContainer = document.getElementById("chartContainer");

            if (!tableContainer || !currentData || currentData.length === 0) return;

            // åˆ›å»ºè¡¨å¤´
            const headers = ['åç§°', 'æµè¡Œåº¦', 'ç”¨æˆ·æ•°', 'å¢é•¿ç‡', 'è–ªèµ„'];
            const headerRow = headers.map(h => `<th>${h}</th>`).join('');

            // åˆ›å»ºæ•°æ®è¡Œ
            const dataRows = currentData.map(item => {
                return `<tr>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.value.toFixed(1)}%</td>
                    <td>${(item.users/1000000).toFixed(1)}M</td>
                    <td>${item.growth.toFixed(1)}%</td>
                    <td>$${(item.salary/1000).toFixed(0)}K</td>
                </tr>`;
            }).join('');

            tableContainer.innerHTML = `
                <table class="fade-in">
                    <thead><tr>${headerRow}</tr></thead>
                    <tbody>${dataRows}</tbody>
                </table>
            `;

            tableContainer.style.display = 'block';
            chartContainer.style.display = 'none';
        }

        /**
         * ç»˜åˆ¶æŸ±çŠ¶å›¾
         */
        function drawBarChart() {
            hideAllCharts();
            const chartContainer = document.getElementById("chartContainer");
            if (!chartContainer || !currentData || currentData.length === 0) return;

            // åˆ›å»ºç®€å•çš„HTMLæŸ±çŠ¶å›¾
            const chartHTML = `
                <div class="fade-in" style="padding: 20px;">
                    <h3 style="text-align: center; margin-bottom: 30px; color: #333;">ç¼–ç¨‹è¯­è¨€æµè¡Œåº¦åˆ†å¸ƒ</h3>
                    <div style="display: flex; align-items: end; height: 300px; gap: 15px; padding: 0 20px;">
                        ${currentData.map(item => `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s ease;">
                                <div style="width: 100%; background: #4a5568;
                                            height: ${(item.value / Math.max(...currentData.map(d => d.value))) * 250}px;
                                            border-radius: 8px 8px 0 0; position: relative;
                                            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
                                            transition: all 0.3s ease;"
                                            onmouseover="this.style.transform='scaleY(1.05)'; this.style.boxShadow='0 6px 20px rgba(74, 85, 104, 0.4)'"
                                            onmouseout="this.style.transform='scaleY(1)'; this.style.boxShadow='0 4px 15px rgba(74, 85, 104, 0.3)'">
                                    <span style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
                                               font-size: 14px; font-weight: bold; color: #4a5568;">${item.value.toFixed(1)}%</span>
                                </div>
                                <div style="margin-top: 15px; font-size: 12px; text-align: center; word-break: break-all; color: #333;">
                                    ${item.name}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            chartContainer.innerHTML = chartHTML;
            chartContainer.style.display = 'block';
        }

        /**
         * ç»˜åˆ¶é¥¼å›¾
         */
        function drawPieChart() {
            hideAllCharts();
            const chartContainer = document.getElementById("chartContainer");
            if (!chartContainer || !currentData || currentData.length === 0) return;

            const total = currentData.reduce((sum, item) => sum + item.value, 0);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

            // åˆ›å»ºç®€å•çš„HTMLé¥¼å›¾
            const chartHTML = `
                <div class="fade-in" style="padding: 20px;">
                    <h3 style="text-align: center; margin-bottom: 30px; color: #333;">ç¼–ç¨‹è¯­è¨€æµè¡Œåº¦å æ¯”</h3>
                    <div style="display: flex; gap: 40px; align-items: center; justify-content: center;">
                        <div style="flex: 0 0 auto;">
                            <div style="width: 280px; height: 280px; border-radius: 50%; background: conic-gradient(
                                ${currentData.map((item, index) => {
                                    const percentage = (item.value / total) * 100;
                                    const startAngle = currentData.slice(0, index).reduce((sum, i) => sum + (i.value / total) * 360, 0);
                                    return `${colors[index]} ${startAngle}deg ${startAngle + (item.value / total) * 360}deg`;
                                }).join(', ')}); position: relative; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                           background: white; border-radius: 50%; width: 120px; height: 120px;
                                           display: flex; align-items: center; justify-content: center; font-weight: bold;
                                           box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; color: #667eea;">æ€»è®¡</div>
                                        <div style="font-size: 16px; color: #333;">${total.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="flex: 0 0 auto;">
                            ${currentData.map((item, index) => `
                                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 8px; background: rgba(255, 255, 255, 0.8); transition: all 0.3s ease;"
                                     onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'; this.style.transform='translateX(5px)'"
                                     onmouseout="this.style.background='rgba(255, 255, 255, 0.8)'; this.style.transform='translateX(0)'">
                                    <div style="width: 20px; height: 20px; background: ${colors[index]};
                                               border-radius: 4px; margin-right: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
                                    <span style="font-size: 14px; color: #333; font-weight: 500;">${item.name}: ${item.value.toFixed(1)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            chartContainer.innerHTML = chartHTML;
            chartContainer.style.display = 'block';
        }

        /**
         * ç»˜åˆ¶æŠ˜çº¿å›¾
         */
        function drawLineChart() {
            hideAllCharts();
            const chartContainer = document.getElementById("chartContainer");
            if (!chartContainer || !currentData || currentData.length === 0) return;

            const maxValue = Math.max(...currentData.map(d => Math.abs(d.growth)));
            const scale = maxValue > 0 ? 100 / maxValue : 1;

            // åˆ›å»ºç®€å•çš„HTMLæŠ˜çº¿å›¾
            const chartHTML = `
                <div class="fade-in" style="padding: 20px;">
                    <h3 style="text-align: center; margin-bottom: 30px; color: #333;">ç¼–ç¨‹è¯­è¨€å¢é•¿ç‡è¶‹åŠ¿</h3>
                    <div style="height: 350px; position: relative; border-left: 2px solid #667eea; border-bottom: 2px solid #667eea; margin: 0 20px; background: rgba(255, 255, 255, 0.5); border-radius: 8px;">
                        <!-- é›¶çº¿ -->
                        <div style="position: absolute; left: 0; right: 0; top: 50%; border-top: 2px dashed #999; z-index: 1;"></div>

                        <!-- ç½‘æ ¼çº¿ -->
                        ${[25, 75].map(pos => `
                            <div style="position: absolute; left: 0; right: 0; top: ${pos}%; border-top: 1px dashed #ddd; z-index: 1;"></div>
                        `).join('')}

                        <!-- æ•°æ®ç‚¹å’Œè¿çº¿ -->
                        <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;">
                            <!-- è¿çº¿ -->
                            <polyline points="${currentData.map((item, index) => {
                                const x = (index / (currentData.length - 1)) * 90 + 5;
                                const y = 50 - (item.growth * scale);
                                return `${x}%,${y}%`;
                            }).join(' ')}"
                            style="fill: none; stroke: #667eea; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round;" />

                            <!-- æ•°æ®ç‚¹ -->
                            ${currentData.map((item, index) => {
                                const x = (index / (currentData.length - 1)) * 90 + 5;
                                const y = 50 - (item.growth * scale);
                                return `
                                    <circle cx="${x}%" cy="${y}%" r="8" fill="#667eea" stroke="white" stroke-width="3"
                                            style="cursor: pointer; transition: all 0.3s ease;"
                                            onmouseover="this.setAttribute('r', '10'); this.style.fill='#764ba2'"
                                            onmouseout="this.setAttribute('r', '8'); this.style.fill='#667eea'">
                                        <title>${item.name}: ${item.growth.toFixed(1)}%</title>
                                    </circle>
                                    <text x="${x}%" y="${y - 5}%" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">
                                        ${item.growth.toFixed(1)}%
                                    </text>
                                `;
                            }).join('')}

                            <!-- Xè½´æ ‡ç­¾ -->
                            ${currentData.map((item, index) => {
                                const x = (index / (currentData.length - 1)) * 90 + 5;
                                return `
                                    <text x="${x}%" y="95%" text-anchor="middle" font-size="12" fill="#666">
                                        ${item.name.length > 10 ? item.name.substring(0, 10) + '...' : item.name}
                                    </text>
                                `;
                            }).join('')}

                            <!-- Yè½´æ ‡ç­¾ -->
                            <text x="2%" y="25%" text-anchor="start" font-size="11" fill="#999">${maxValue.toFixed(0)}%</text>
                            <text x="2%" y="50%" text-anchor="start" font-size="11" fill="#999">0%</text>
                            <text x="2%" y="75%" text-anchor="start" font-size="11" fill="#999">-${maxValue.toFixed(0)}%</text>
                        </svg>
                    </div>
                    <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                        å¢é•¿ç‡ (%) - é›¶çº¿ä»¥ä¸Šä¸ºæ­£å¢é•¿ï¼Œé›¶çº¿ä»¥ä¸‹ä¸ºè´Ÿå¢é•¿
                    </div>
                </div>
            `;

            chartContainer.innerHTML = chartHTML;
            chartContainer.style.display = 'block';
        }

        /**
         * åˆ·æ–°æ•°æ®
         */
        function refreshData() {
            console.log("åˆ·æ–°æ•°æ®...");
            loadDataAndDraw();
        }

        /**
         * éšè—æ‰€æœ‰å›¾è¡¨
         */
        function hideAllCharts() {
            const chartContainer = document.getElementById("chartContainer");
            const tableContainer = document.getElementById("tableContainer");

            if (chartContainer) chartContainer.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'none';
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
         */
        function showError(message) {
            const chartContainer = document.getElementById("chartContainer");
            if (chartContainer) {
                chartContainer.innerHTML = `<div class="error-message fade-in">é”™è¯¯: ${message}</div>`;
                chartContainer.style.display = 'block';
            }
        }
    </script>
</body>
</html>